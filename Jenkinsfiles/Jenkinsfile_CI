pipeline {
    agent any

    environment {
        PROJECT_ID = "fluted-factor-438905-d2"
        REGION = "asia-south1"
        REPO = "java-sample-repo"
        IMAGE_NAME = "java-sample-app"
        GAR_PATH = "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE_NAME}"
        GCP_KEY_PATH = "C:/Users/LENOVO/Downloads/gcp-key.json"
        NEW_VERSION = "v${BUILD_NUMBER}"
    }

    triggers {
        githubPush() 
    }

    stages {
        stage('Checkout Source') {
            steps {
                git branch: 'feature-branch', url: 'https://github.com/sohel-09/Sample-Java-App'
            }
        }

        stage('Authenticate to GCP') {
            steps {
                sh "gcloud auth activate-service-account --key-file=${GCP_KEY_PATH}"
                sh "gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet"
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                sh """
                    docker build -t ${IMAGE_NAME}:latest .
                    docker tag ${IMAGE_NAME}:latest ${GAR_PATH}:${NEW_VERSION}
                    docker push ${GAR_PATH}:${NEW_VERSION}
                    docker tag ${IMAGE_NAME}:latest ${GAR_PATH}:latest
                    docker push ${GAR_PATH}:latest
                """
            }
        }
    }

    post {
        success {
            echo "✅ Docker image pushed: ${GAR_PATH}:${NEW_VERSION}"
            // Trigger CD pipeline 
            build job: 'Java_CD_Pipeline', parameters: [string(name: 'IMAGE_VERSION', value: "${NEW_VERSION}")]
        }
        failure {
            echo "❌ CI pipeline failed!"
        }
    }
}
